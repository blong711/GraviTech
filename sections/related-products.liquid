{% comment %}
  Related Products Section
  - Uses Shopify's product recommendations API
  - Responsive carousel with Swiper
  - Configurable product display options
  - Lazy loads recommendations when section comes into view
{% endcomment %}

<div 
  class="product-recommendations" 
  data-url="{{ routes.product_recommendations_url }}?section_id={{ section.id }}&product_id={{ product.id }}&limit={{ section.settings.products_to_show }}&intent=related"
>
  {%- if recommendations.performed? and recommendations.products_count > 0 -%}
    <section class="color-{{ section.settings.color_scheme }} section-{{ section.id }}-padding">
      <div class="{{ section.settings.width }}">
        {%- if section.settings.heading != blank -%}
          <div class="flat-title wow fadeInUp">
            <h4 class="title">{{ section.settings.heading }}</h4>
          </div>
        {%- endif -%}
        
        <div class="hover-sw-nav hover-sw-2 wow fadeInUp">
          <div dir="ltr" class="swiper tf-swiper wrap-sw-over" data-swiper='{
            "slidesPerView": {{ section.settings.items_per_row_mobile }},
            "spaceBetween": 12,
            "speed": 800,
            "observer": true,
            "observeParents": true,
            "slidesPerGroup": {{ section.settings.items_per_row_mobile }},
            "navigation": {
              "clickable": true,
              "nextEl": ".nav-next-bought",
              "prevEl": ".nav-prev-bought"
            },
            "pagination": { "el": ".sw-pagination-bought", "clickable": true },
            "breakpoints": {
              "768": { 
                "slidesPerView": {{ section.settings.items_per_row_tablet }}, 
                "spaceBetween": 12, 
                "slidesPerGroup": {{ section.settings.items_per_row_tablet }} 
              },
              "1200": { 
                "slidesPerView": {{ section.settings.items_per_row_desktop }}, 
                "spaceBetween": 24, 
                "slidesPerGroup": {{ section.settings.items_per_row_desktop }}
              }
            }
          }'>
            <div class="swiper-wrapper">
              {%- for product in recommendations.products -%}
                <div class="swiper-slide">
                  {% render 'product-card', product: product, show_progress_sale: false %}
                </div>
              {%- endfor -%}
            </div>
            
            {%- if section.settings.show_mobile_dots -%}
              <div class="d-flex d-xl-none sw-dot-default sw-pagination-bought justify-content-center"></div>
            {%- endif -%}
          </div>
          
          {%- if section.settings.show_navigation -%}
            <div class="d-none d-xl-flex swiper-button-next nav-swiper nav-next-bought"></div>
            <div class="d-none d-xl-flex swiper-button-prev nav-swiper nav-prev-bought"></div>
          {%- endif -%}
        </div>
      </div>
    </section>
  {%- endif -%}
</div>

<style>
.section-{{ section.id }}-padding {
    padding-top: calc({{ section.settings.padding_top }}px * {{ section.settings.padding_mobile_rate | divided_by: 100.0 }});
    padding-bottom: calc({{ section.settings.padding_bottom }}px * {{ section.settings.padding_mobile_rate | divided_by: 100.0 }});
}
    
@media screen and (min-width: 750px) {
    .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top }}px;
    padding-bottom: {{ section.settings.padding_bottom }}px;
    }
}
</style>

{% javascript %}
  // Function to initialize related products section
  function initializeRelatedProducts() {
    const productRecommendationsSection = document.querySelector('.product-recommendations');
    if (!productRecommendationsSection) return;

    // Check if products are already loaded
    const hasProducts = productRecommendationsSection.querySelector('.swiper-wrapper .swiper-slide');
    if (hasProducts) {
      // Products are already loaded, just reinitialize Swiper
      const swiperContainer = productRecommendationsSection.querySelector('.swiper');
      if (swiperContainer && !swiperContainer.swiper) {
        const swiperData = JSON.parse(swiperContainer.dataset.swiper);
        new Swiper(swiperContainer, swiperData);
      }
      return;
    }

    // Set up intersection observer for lazy loading
    const handleIntersection = (entries, observer) => {
      if (!entries[0].isIntersecting) return;

      observer.unobserve(productRecommendationsSection);

      const url = productRecommendationsSection.dataset.url;

      fetch(url)
        .then(response => response.text())
        .then(text => {
          const html = document.createElement('div');
          html.innerHTML = text;
          const recommendations = html.querySelector('.product-recommendations');

          if (recommendations && recommendations.innerHTML.trim().length) {
            productRecommendationsSection.innerHTML = recommendations.innerHTML;
            
            // Reinitialize Swiper after content is loaded
            const swiperContainer = productRecommendationsSection.querySelector('.swiper');
            if (swiperContainer) {
              const swiperData = JSON.parse(swiperContainer.dataset.swiper);
              new Swiper(swiperContainer, swiperData);
            }
            
            // Reinitialize wishlist and compare buttons after content is loaded
            if (typeof initializeWishlistButtons === 'function') {
              initializeWishlistButtons();
            }
            if (typeof initializeCompareButtons === 'function') {
              initializeCompareButtons();
            }
          }
        })
        .catch(e => {
          console.error(e);
        });
    };

    const observer = new IntersectionObserver(handleIntersection, {rootMargin: '0px 0px 200px 0px'});
    observer.observe(productRecommendationsSection);
  }

  // Initialize on page load
  initializeRelatedProducts();

  // Handle theme customizer changes
  if (window.Shopify && window.Shopify.designMode) {
    // Listen for section load events
    document.addEventListener('shopify:section:load', (event) => {
      // Check if the loaded section is the related products section
      if (event.target.querySelector('.product-recommendations')) {
        setTimeout(() => {
          initializeRelatedProducts();
        }, 100);
      }
    });

    // Listen for section reorder events
    document.addEventListener('shopify:section:reorder', (event) => {
      // Check if the reordered section is the related products section
      if (event.target.querySelector('.product-recommendations')) {
        setTimeout(() => {
          initializeRelatedProducts();
        }, 100);
      }
    });

    // Listen for section select events
    document.addEventListener('shopify:section:select', (event) => {
      // Check if the selected section is the related products section
      if (event.target.querySelector('.product-recommendations')) {
        setTimeout(() => {
          initializeRelatedProducts();
        }, 100);
      }
    });
  }
{% endjavascript %}

{% schema %}
{
  "name": "t:sections.related-products.name",
  "settings": [
    {
        "type": "color_scheme",
        "id": "color_scheme",
        "label": "t:sections.all.colors.label",
        "default": "scheme-1"
    },
    {
        "type": "select",
        "id": "width",
        "label": "t:sections.all.width.label",
        "options": [
            {
            "value": "container",
            "label": "t:sections.all.width.options.boxed"
            },
            {
            "value": "container-full",
            "label": "t:sections.all.width.options.full_width"
            }
        ],
        "default": "container"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "t:sections.related-products.settings.heading.label",
      "default": "t:sections.related-products.settings.heading.default"
    },
    {
      "type": "range",
      "id": "products_to_show",
      "min": 2,
      "max": 12,
      "step": 1,
      "default": 5,
      "label": "t:sections.related-products.settings.products_to_show.label"
    },
    {
        "type": "header",
        "content": "t:sections.brands.settings.slider_settings.content"
    },
    {
        "type": "checkbox",
        "id": "show_navigation",
        "label": "t:sections.brands.settings.show_arrows.label",
        "default": true
    },
    {
        "type": "checkbox",
        "id": "show_mobile_dots",
        "label": "t:sections.brands.settings.show_mobile_dots.label",
        "default": true
    },
    {
        "type": "select",
        "id": "items_per_row_desktop",
        "options": [
          {
            "value": "2",
            "label": "2"
          },
          {
            "value": "3",
            "label": "3"
          },
          {
            "value": "4",
            "label": "4"
          }
        ],
        "label": "t:sections.brands.settings.items_per_row_desktop.label",
        "default": "4"
    },
    {
        "type": "select",
        "id": "items_per_row_tablet",
        "options": [
          {
            "value": "2",
            "label": "2"
          },
          {
            "value": "3",
            "label": "3"
          },
          {
            "value": "4",
            "label": "4"
          }
        ],
        "label": "t:sections.brands.settings.items_per_row_tablet.label",
        "default": "4"
    },
    {
        "type": "select",
        "id": "items_per_row_mobile",
        "options": [
          {
            "value": "1",
            "label": "1"
          },
          {
            "value": "2",
            "label": "2"
          }
        ],
        "label": "t:sections.brands.settings.items_per_row_mobile.label",
        "default": "2"
    },
    {
        "type": "header",
        "content": "t:sections.all.padding.section_padding_heading"
    },
    {
        "type": "range",
        "id": "padding_top",
        "min": 0,
        "max": 100,
        "step": 4,
        "unit": "px",
        "label": "t:sections.all.padding.padding_top",
        "default": 0
    },
    {
        "type": "range",
        "id": "padding_bottom",
        "min": 0,
        "max": 100,
        "step": 4,
        "unit": "px",
        "label": "t:sections.all.padding.padding_bottom",
        "default": 0
    },
    {
      "type": "range",
      "id": "padding_mobile_rate",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "%",
      "label": "t:sections.all.padding.padding_mobile_rate.label",
      "default": 75,
      "info": "t:sections.all.padding.padding_mobile_rate.info"
    }
  ],
  "presets": [
    {
      "name": "t:sections.related-products.name"
    }
  ]
}
{% endschema %}