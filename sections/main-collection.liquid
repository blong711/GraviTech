{% comment %} Settings {% endcomment %}
{% assign max_products_per_page = section.settings.max_products_per_page | default: 8 %}
{% assign pagination_type = section.settings.pagination_type | default: 'pagination' %}
{% assign default_grid_layout = section.settings.default_grid_layout | default: 'tf-col-4' %}
{% assign default_layout_type = section.settings.default_layout_type | default: 'grid' %}
{% assign total_products = collection.products.size %}

{% comment %} For load more functionality, use a very high pagination limit to show all products {% endcomment %}
{% if pagination_type == 'load_more' or pagination_type == 'infinity_scroll' %}
    {% assign pagination_limit = 1000 %}
{% else %}
    {% assign pagination_limit = max_products_per_page %}
{% endif %}

{% paginate collection.products by pagination_limit %}

{% comment %} For load more functionality, we need all products rendered {% endcomment %}
{% comment %} Remove pagination limit to allow JavaScript load more to work {% endcomment %}

<section class="flat-spacing pt-0">
    <div class="container">
        <div class="tf-shop-control">
            <div class="tf-group-filter">
                <a href="#filterShop" data-bs-toggle="offcanvas" aria-controls="filterShop"
                    class="tf-btn-filter">
                    <span class="icon icon-filter"></span><span class="text">Filter</span></a>
                <div class="tf-dropdown-sort" data-bs-toggle="dropdown">
                    <div class="btn-select">
                        <span class="text-sort-value">Best selling</span>
                        <span class="icon icon-arr-down"></span>
                    </div>
                    <div class="dropdown-menu">
                        <div class="select-item active" data-sort-value="best-selling">
                            <span class="text-value-item">Best selling</span>
                        </div>
                        <div class="select-item" data-sort-value="a-z">
                            <span class="text-value-item">Alphabetically, A-Z</span>
                        </div>
                        <div class="select-item" data-sort-value="z-a">
                            <span class="text-value-item">Alphabetically, Z-A</span>
                        </div>
                        <div class="select-item" data-sort-value="price-low-high">
                            <span class="text-value-item">Price, low to high</span>
                        </div>
                        <div class="select-item" data-sort-value="price-high-low">
                            <span class="text-value-item">Price, high to low</span>
                        </div>
                    </div>
                </div>
            </div>
            <ul class="tf-control-layout">
                <li class="tf-view-layout-switch sw-layout-list list-layout" data-value-layout="list">
                    <div class="item icon-list">
                        <span></span>
                        <span></span>
                    </div>
                </li>
                <li class="tf-view-layout-switch sw-layout-2" data-value-layout="tf-col-2">
                    <div class="item icon-grid-2">
                        <span></span>
                        <span></span>
                    </div>
                </li>
                <li class="tf-view-layout-switch sw-layout-3" data-value-layout="tf-col-3">
                    <div class="item icon-grid-3">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </li>
                <li class="tf-view-layout-switch sw-layout-4" data-value-layout="tf-col-4">
                    <div class="item icon-grid-4">
                        <span></span>
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </li>
            </ul>
        </div>
        
        <div class="wrapper-control-shop">
            <div class="meta-filter-shop">
                <div id="product-count-grid" class="count-text">
                    {% if total_products > 0 %}
                        <span class="count">{{ total_products }}</span> Products found
                    {% else %}
                        No products found
                    {% endif %}
                </div>
                <div id="product-count-list" class="count-text">
                    {% if total_products > 0 %}
                        <span class="count">{{ total_products }}</span> Products found
                    {% else %}
                        No products found
                    {% endif %}
                </div>
                <div id="applied-filters"></div>
                <button id="remove-all" class="remove-all-filters" style="display: none;">
                    <i class="icon icon-close"></i> Clear all filters
                </button>
            </div>
            
            {% comment %} List Layout {% endcomment %}
            <div class="tf-list-layout wrapper-shop" id="listLayout" style="display: none;">
                {% if collection.products.size > 0 %}
                    {% for product in collection.products %}
                        {% render 'product-card-list', product: product %}
                    {% endfor %}
                    
                    {% comment %} Pagination or Load More {% endcomment %}
                    {% if pagination_type == 'pagination' %}
                        {% if paginate.pages > 1 %}
                            <ul class="wg-pagination">
                                {% if paginate.previous %}
                                    <li>
                                        <a href="{{ paginate.previous.url }}" class="pagination-item">
                                            <i class="icon-arr-left"></i>
                                        </a>
                                    </li>
                                {% endif %}
                                
                                {% for part in paginate.parts %}
                                    {% if part.is_link %}
                                        <li>
                                            <a href="{{ part.url }}" class="pagination-item">{{ part.title }}</a>
                                        </li>
                                    {% else %}
                                        {% if part.title == paginate.current_page %}
                                            <li class="active">
                                                <div class="pagination-item">{{ part.title }}</div>
                                            </li>
                                        {% else %}
                                            <li>
                                                <div class="pagination-item">{{ part.title }}</div>
                                            </li>
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                                
                                {% if paginate.next %}
                                    <li>
                                        <a href="{{ paginate.next.url }}" class="pagination-item">
                                            <i class="icon-arr-right2"></i>
                                        </a>
                                    </li>
                                {% endif %}
                            </ul>
                        {% endif %}
                    {% else %}
                        {% comment %} Load More Button for List Layout {% endcomment %}
                        {% if total_products > max_products_per_page %}
                            <div class="wd-load d-flex justify-content-center">
                                <button id="loadMoreListBtn" class="tf-btn btn-out-line-dark2 tf-loading loadmore" 
                                        data-layout="list" 
                                        data-current-page="1" 
                                        data-max-per-page="{{ max_products_per_page }}"
                                        data-total-products="{{ total_products }}">
                                    <span class="text">Load more</span>
                                    <div class="spinner-circle">
                                        <span class="spinner-circle1 spinner-child"></span>
                                        <span class="spinner-circle2 spinner-child"></span>
                                        <span class="spinner-circle3 spinner-child"></span>
                                        <span class="spinner-circle4 spinner-child"></span>
                                        <span class="spinner-circle5 spinner-child"></span>
                                        <span class="spinner-circle6 spinner-child"></span>
                                        <span class="spinner-circle7 spinner-child"></span>
                                        <span class="spinner-circle8 spinner-child"></span>
                                        <span class="spinner-circle9 spinner-child"></span>
                                    </div>
                                </button>
                            </div>
                        {% endif %}
                        
                        {% comment %} Infinity Scroll for List Layout {% endcomment %}
                        {% if pagination_type == 'infinity_scroll' and total_products > max_products_per_page %}
                            <div class="wd-load d-flex justify-content-center">
                                <button id="infiniteScrollList" class="tf-btn btn-dark2 tf-loading animate-btn animate-dark">
                                    <div class="spinner-circle">
                                        <span class="spinner-circle1 spinner-child"></span>
                                        <span class="spinner-circle2 spinner-child"></span>
                                        <span class="spinner-circle3 spinner-child"></span>
                                        <span class="spinner-circle4 spinner-child"></span>
                                        <span class="spinner-circle5 spinner-child"></span>
                                        <span class="spinner-circle6 spinner-child"></span>
                                        <span class="spinner-circle7 spinner-child"></span>
                                        <span class="spinner-circle8 spinner-child"></span>
                                        <span class="spinner-circle9 spinner-child"></span>
                                    </div>
                                </button>
                            </div>
                        {% endif %}
                    {% endif %}
                {% else %}
                    <div class="text-center py-5">
                        <p class="text-lg">No products found in this collection.</p>
                    </div>
                {% endif %}
            </div>
            
            {% comment %} Grid Layout {% endcomment %}
            <div class="wrapper-shop tf-grid-layout {{ default_grid_layout }}" id="gridLayout">
                {% if collection.products.size > 0 %}
                    {% for product in collection.products %}
                        {% render 'product-card', product: product %}
                    {% endfor %}
                    
                    {% comment %} Pagination or Load More {% endcomment %}
                    {% if pagination_type == 'pagination' %}
                        {% if paginate.pages > 1 %}
                            <ul class="wg-pagination">
                                {% if paginate.previous %}
                                    <li>
                                        <a href="{{ paginate.previous.url }}" class="pagination-item">
                                            <i class="icon-arr-left"></i>
                                        </a>
                                    </li>
                                {% endif %}
                                
                                {% for part in paginate.parts %}
                                    {% if part.is_link %}
                                        <li>
                                            <a href="{{ part.url }}" class="pagination-item">{{ part.title }}</a>
                                        </li>
                                    {% else %}
                                        {% if part.title == paginate.current_page %}
                                            <li class="active">
                                                <div class="pagination-item">{{ part.title }}</div>
                                            </li>
                                        {% else %}
                                            <li>
                                                <div class="pagination-item">{{ part.title }}</div>
                                            </li>
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                                
                                {% if paginate.next %}
                                    <li>
                                        <a href="{{ paginate.next.url }}" class="pagination-item">
                                            <i class="icon-arr-right2"></i>
                                        </a>
                                    </li>
                                {% endif %}
                            </ul>
                        {% endif %}
                    {% else %}
                        {% comment %} Load More Button for Grid Layout {% endcomment %}
                        {% if total_products > max_products_per_page %}
                            <div class="wd-load d-flex justify-content-center">
                                <button id="loadMoreGridBtn" class="tf-btn btn-out-line-dark2 tf-loading loadmore"
                                        data-layout="grid" 
                                        data-current-page="1" 
                                        data-max-per-page="{{ max_products_per_page }}"
                                        data-total-products="{{ total_products }}">
                                    <span class="text">Load more</span>
                                    <div class="spinner-circle">
                                        <span class="spinner-circle1 spinner-child"></span>
                                        <span class="spinner-circle2 spinner-child"></span>
                                        <span class="spinner-circle3 spinner-child"></span>
                                        <span class="spinner-circle4 spinner-child"></span>
                                        <span class="spinner-circle5 spinner-child"></span>
                                        <span class="spinner-circle6 spinner-child"></span>
                                        <span class="spinner-circle7 spinner-child"></span>
                                        <span class="spinner-circle8 spinner-child"></span>
                                        <span class="spinner-circle9 spinner-child"></span>
                                    </div>
                                </button>
                            </div>
                        {% endif %}
                        
                        {% comment %} Infinity Scroll for Grid Layout {% endcomment %}
                        {% if pagination_type == 'infinity_scroll' and total_products > max_products_per_page %}
                            <div class="wd-load d-flex justify-content-center">
                                <button id="infiniteScrollGrid" class="tf-btn btn-dark2 tf-loading animate-btn animate-dark">
                                    <div class="spinner-circle">
                                        <span class="spinner-circle1 spinner-child"></span>
                                        <span class="spinner-circle2 spinner-child"></span>
                                        <span class="spinner-circle3 spinner-child"></span>
                                        <span class="spinner-circle4 spinner-child"></span>
                                        <span class="spinner-circle5 spinner-child"></span>
                                        <span class="spinner-circle6 spinner-child"></span>
                                        <span class="spinner-circle7 spinner-child"></span>
                                        <span class="spinner-circle8 spinner-child"></span>
                                        <span class="spinner-circle9 spinner-child"></span>
                                    </div>
                                </button>
                            </div>
                        {% endif %}
                    {% endif %}
                {% else %}
                    <div class="text-center py-5">
                        <p class="text-lg">No products found in this collection.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>


{% comment %} Render the filter snippet {% endcomment %}
{% render 'collection-filters', 
    collection: collection,
    show_on_sale: section.settings.show_on_sale,
    on_sale_limit: section.settings.on_sale_limit,
    show_collection_banner: section.settings.show_collection_banner,
    collection_banner_image: section.settings.collection_banner_image,
    collection_banner_title: section.settings.collection_banner_title,
    collection_banner_button_text: section.settings.collection_banner_button_text,
    collection_banner_button_url: section.settings.collection_banner_button_url,
    show_availability_filter: section.settings.show_availability_filter,
    show_price_filter: section.settings.show_price_filter,
    show_color_filter: section.settings.show_color_filter,
    show_brand_filter: section.settings.show_brand_filter
%}

{% comment %} Add necessary data for JavaScript {% endcomment %}
<script>
    window.collectionData = {
        totalProducts: {{ total_products }},
        priceMin: {{ collection.price_min | divided_by: 100.0 | round: 0 }},
        priceMax: {{ collection.price_max | divided_by: 100.0 | round: 0 }},
        paginationType: '{{ pagination_type }}',
        maxProductsPerPage: {{ max_products_per_page }},
        defaultGridLayout: '{{ default_grid_layout }}',
        defaultLayoutType: '{{ default_layout_type }}'
    };
</script>

{% endpaginate %}

{% comment %} Schema for section settings {% endcomment %}
{% schema %}
{
    "name": "Main Collection",
    "settings": [
        {
            "type": "range",
            "id": "max_products_per_page",
            "label": "Products per page",
            "min": 4,
            "max": 48,
            "step": 4,
            "default": 8,
            "info": "Number of products to display per page"
        },
        {
            "type": "select",
            "id": "default_layout_type",
            "label": "Default layout type",
            "options": [
                { "value": "grid", "label": "Grid" },
                { "value": "list", "label": "List" }
            ],
            "default": "grid"
        },
        {
            "type": "select",
            "id": "default_grid_layout",
            "label": "Grid layout",
            "options": [
                { "value": "tf-col-2", "label": "2 Columns" },
                { "value": "tf-col-3", "label": "3 Columns" },
                { "value": "tf-col-4", "label": "4 Columns" }
            ],
            "default": "tf-col-4",
            "visible_if": "{{ section.settings.default_layout_type == 'grid' }}"
        },
        {
            "type": "select",
            "id": "pagination_type",
            "label": "Pagination type",
            "options": [
                { "value": "pagination", "label": "Pagination" },
                { "value": "load_more", "label": "Load More" },
                { "value": "infinity_scroll", "label": "Infinity Scroll" }
            ],
            "default": "pagination"
        },
        {
            "type": "header",
            "content": "Filter Sidebar Settings"
        },
        {
            "type": "checkbox",
            "id": "show_on_sale",
            "label": "Show on-sale products in filters",
            "default": true,
            "info": "Display on-sale products preview in the filter sidebar"
        },
        {
            "type": "range",
            "id": "on_sale_limit",
            "label": "On-sale products limit",
            "min": 1,
            "max": 10,
            "step": 1,
            "default": 3,
            "info": "Maximum number of on-sale products to show in filters"
        },
        {
            "type": "checkbox",
            "id": "show_collection_banner",
            "label": "Show collection banner in filters",
            "default": true,
            "info": "Display promotional banner in the filter sidebar"
        },
        {
            "type": "image_picker",
            "id": "collection_banner_image",
            "label": "Collection banner image",
            "info": "Recommended size: 300x200px"
        },
        {
            "type": "text",
            "id": "collection_banner_title",
            "label": "Banner title",
            "default": "Elevate Your Style",
            "info": "Main text displayed on the banner"
        },
        {
            "type": "text",
            "id": "collection_banner_button_text",
            "label": "Banner button text",
            "default": "Shop Now",
            "info": "Text for the call-to-action button"
        },
        {
            "type": "url",
            "id": "collection_banner_button_url",
            "label": "Banner button URL",
            "default": "",
            "info": "URL for the banner button (leave empty to use collection URL)"
        },
        {
            "type": "header",
            "content": "Filter Options"
        },
        {
            "type": "checkbox",
            "id": "show_availability_filter",
            "label": "Show availability filter",
            "default": true,
            "info": "Display in-stock/out-of-stock filter options"
        },
        {
            "type": "checkbox",
            "id": "show_price_filter",
            "label": "Show price filter",
            "default": true,
            "info": "Display price range slider filter"
        },
        {
            "type": "checkbox",
            "id": "show_color_filter",
            "label": "Show color filter",
            "default": true,
            "info": "Display color selection filter options"
        },
        {
            "type": "checkbox",
            "id": "show_brand_filter",
            "label": "Show brand filter",
            "default": true,
            "info": "Display brand/vendor filter options"
        }
    ]
}
{% endschema %}